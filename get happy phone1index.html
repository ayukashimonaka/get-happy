<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xmas Pair Game (Fix)</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            height: 100vh; overflow: hidden;
            font-family: 'Arial', sans-serif;
            user-select: none; color: white; touch-action: none; text-align: center;
        }

        .screen { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        .active { display: flex; flex-direction: column; justify-content: center; align-items: center; }

        h1 { margin-bottom: 30px; font-size: 24px; text-shadow: 0 0 10px gold; }
        .btn {
            background: #e63946; color: white; border: none; padding: 20px 40px;
            font-size: 20px; border-radius: 50px; margin: 10px; font-weight: bold;
            box-shadow: 0 5px 0 #b71c1c; width: 80%; max-width: 300px;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 1px 0 #b71c1c; }
        .btn-blue { background: #457b9d; box-shadow: 0 5px 0 #1d3557; }
        .btn-blue:active { box-shadow: 0 1px 0 #1d3557; }

        input[type="text"] {
            padding: 15px; font-size: 24px; text-align: center; border-radius: 10px;
            border: none; width: 200px; margin-bottom: 20px; text-transform: uppercase;
        }

        .tap-area {
            width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(255,255,255,0.1); cursor: pointer;
        }
        .id-display { font-size: 40px; font-weight: bold; color: #ffd700; margin: 20px 0; letter-spacing: 5px; }
        .status { font-size: 14px; color: #ccc; margin-top: 10px; }

        /* ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        .game-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none;}
        
        .present {
            position: fixed; z-index: 50; font-size: 40px; pointer-events: none; will-change: top;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3));
            /* åˆ¤å®šã‚’ç¢ºèªã—ã‚„ã™ãã™ã‚‹ãŸã‚ã€å››è§’ã„æ ã¯ã„ã£ãŸã‚“æ¶ˆã—ã¦ãŠãã¾ã™ */
        }

        /* é´ä¸‹ */
        .sock-container {
            position: absolute; bottom: 40px; left: 50%; width: 70px; height: 110px; z-index: 100;
            transform: translateX(-35px); pointer-events: none;
        }
        .sock-body { position: absolute; bottom: 25px; left: 0; width: 55px; height: 85px; background-color: #d32f2f; border-radius: 0 0 25px 25px; }
        .sock-foot { position: absolute; bottom: 25px; left: 25px; width: 55px; height: 45px; background-color: #d32f2f; border-radius: 0 30px 30px 0; }
        .sock-top { position: absolute; top: 0; left: -5px; width: 65px; height: 30px; background-color: #f5f5f5; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .sock-heel { position: absolute; bottom: 25px; left: 0; width: 30px; height: 30px; background-color: #b71c1c; border-radius: 0 100% 0 0; }

        .score-board { position: absolute; top: 20px; right: 20px; font-size: 30px; color: #ffd700; font-weight: bold; text-shadow: 2px 2px 0 #000; z-index: 200; }
        .catch-effect { position: absolute; color: #ffd700; font-weight: bold; font-size: 30px; animation: floatUp 0.5s forwards; text-shadow: 0 0 5px orange; z-index: 150; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-50px) scale(1.5); opacity: 0; } }

    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <h1>Xmas Pair Game</h1>
        <button class="btn" onclick="setupHost()">æŠ•ã’ã‚‹å½¹ (è¦ª)</button>
        <button class="btn btn-blue" onclick="showJoin()">ã‚­ãƒ£ãƒƒãƒå½¹ (å­)</button>
        <div style="margin-top:20px; font-size:12px; color:#aaa;">ã‚¹ãƒãƒ›2å°ã§éŠã‚“ã§ã­</div>
    </div>

    <div id="screen-host" class="screen">
        <h3>ã“ã®IDã‚’ç›¸æ‰‹ã«å…¥åŠ›ã—ã¦ã­</h3>
        <div class="id-display" id="my-id-display">...</div>
        <div class="status" id="host-status">æ¥ç¶šå¾…ã¡...</div>
        <div class="tap-area" id="tapArea" style="display:none;">
            <h2>TAP HERE!</h2>
            <div style="font-size:60px;">ğŸ</div>
            <p>ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ç›¸æ‰‹ã«è½ã¡ã‚‹ã‚ˆ</p>
        </div>
    </div>

    <div id="screen-join" class="screen">
        <h3>ç›¸æ‰‹ã®IDã‚’å…¥ã‚Œã¦ã­</h3>
        <input type="text" id="join-id-input" maxlength="4" placeholder="ABCD">
        <button class="btn btn-blue" onclick="joinGame()">æ¥ç¶šã™ã‚‹</button>
    </div>

    <div id="screen-game" class="screen">
        <div class="score-board">SCORE: <span id="scoreVal">0</span></div>
        <div class="status" style="position:absolute; top:10px; left:10px;">æ¥ç¶šä¸­</div>
        <div class="game-layer" id="gameArea"></div>
        <div class="sock-container" id="playerSock">
            <div class="sock-foot"></div>
            <div class="sock-body"></div>
            <div class="sock-heel"></div>
            <div class="sock-top"></div>
        </div>
    </div>

    <script>
        let peer;
        let conn;
        let myId = '';
        
        function generateShortId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function setupHost() {
            showScreen('screen-host');
            const shortId = generateShortId();
            const peerId = 'xmas_game_' + shortId;
            peer = new Peer(peerId);

            peer.on('open', (id) => {
                myId = shortId;
                document.getElementById('my-id-display').innerText = shortId;
            });
            peer.on('error', (err) => {
                alert('IDãŒé‡è¤‡ã—ã¾ã—ãŸã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã­');
                location.reload();
            });
            peer.on('connection', (c) => {
                conn = c;
                document.getElementById('host-status').innerText = "ã¤ãªãŒã£ãŸã‚ˆï¼";
                document.getElementById('tapArea').style.display = 'flex';
                setupTapEvent();
            });
        }

        function setupTapEvent() {
            const area = document.getElementById('tapArea');
            const sendDrop = (e) => {
                e.preventDefault();
                if(!conn) return;
                area.style.backgroundColor = 'rgba(255,255,255,0.3)';
                setTimeout(() => area.style.backgroundColor = 'rgba(255,255,255,0.1)', 100);

                const emojis = ['ğŸ', 'ğŸ§¸', 'ğŸ¬', 'ğŸ””', 'ğŸ’', 'ğŸ°'];
                const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                const x = 10 + Math.random() * 80;
                
                conn.send({ type: 'DROP', emoji: emoji, x: x });
            };
            area.addEventListener('touchstart', sendDrop);
            area.addEventListener('click', sendDrop);
        }

        function showJoin() { showScreen('screen-join'); }

        function joinGame() {
            const inputVal = document.getElementById('join-id-input').value.toUpperCase();
            if(inputVal.length !== 4) { alert('4æ–‡å­—ã®IDã‚’å…¥ã‚Œã¦ã­'); return; }
            const targetPeerId = 'xmas_game_' + inputVal;
            peer = new Peer();

            peer.on('open', (id) => {
                conn = peer.connect(targetPeerId);
                conn.on('open', () => { startGameClient(); });
                conn.on('data', (data) => {
                    if(data.type === 'DROP') spawnPresent(data);
                });
                conn.on('error', () => { alert('æ¥ç¶šå¤±æ•—ã€‚IDã‚’ç¢ºèªã—ã¦ã­'); });
            });
        }

        let score = 0;
        let fallingItems = [];

        function startGameClient() {
            showScreen('screen-game');
            const playerSock = document.getElementById('playerSock');
            
            // æŒ‡ã®ä½ç½®ã«è¿½å¾“ï¼ˆå°‘ã—è£œæ­£ã‚’å…¥ã‚Œã¦è¦‹ã‚„ã™ãã™ã‚‹ï¼‰
            window.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                let x = touch.clientX;
                playerSock.style.left = x + 'px';
            }, { passive: false });

            window.addEventListener('mousemove', (e) => {
                playerSock.style.left = e.clientX + 'px';
            });

            requestAnimationFrame(gameLoop);
        }

        function spawnPresent(data) {
            const el = document.createElement('div');
            el.classList.add('present');
            el.innerText = data.emoji;
            el.style.left = data.x + '%';
            el.style.top = '-10%';

            document.getElementById('screen-game').appendChild(el);

            const duration = 2000 + Math.random() * 1000;
            el.style.transition = `top ${duration}ms linear`;
            requestAnimationFrame(() => { el.style.top = '110vh'; });

            const item = { el: el, caught: false, id: Date.now() + Math.random() };
            fallingItems.push(item);

            setTimeout(() => {
                if(el.parentNode) el.remove();
                fallingItems = fallingItems.filter(i => i.id !== item.id);
            }, duration + 100);
        }

        // â˜…â˜…â˜… ã“ã“ãŒä¿®æ­£ã•ã‚ŒãŸå½“ãŸã‚Šåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        function gameLoop() {
            const playerSock = document.getElementById('playerSock');
            const sockRect = playerSock.getBoundingClientRect();
            
            // åˆ¤å®šã‚¨ãƒªã‚¢ï¼ˆå°‘ã—åºƒã‚ã«ã™ã‚‹ï¼šå·¦å³+10pxï¼‰
            // é´ä¸‹ã®å£ã®é«˜ã•ï¼ˆä¸Šéƒ¨ï¼‰ã§åˆ¤å®š
            const hitZone = {
                left: sockRect.left - 10,  // å·¦ã«10pxç”˜ã
                right: sockRect.right + 10,// å³ã«10pxç”˜ã
                top: sockRect.top,
                bottom: sockRect.top + 60  // é«˜ã•ã‚’60pxç¢ºä¿
            };

            fallingItems.forEach(item => {
                if(item.caught) return;
                
                // ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã®çŸ©å½¢ã‚’å–å¾—
                const pRect = item.el.getBoundingClientRect();

                // ã€çŸ©å½¢åŒå£«ã®äº¤å·®åˆ¤å®šã€‘
                // ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã®ã©ã“ã‹ãŒã€åˆ¤å®šã‚¨ãƒªã‚¢ã«é‡ãªã£ã¦ã„ã‚Œã°OK
                if (
                    pRect.left < hitZone.right && 
                    pRect.right > hitZone.left &&
                    pRect.top < hitZone.bottom &&
                    pRect.bottom > hitZone.top
                ) {
                    catchItem(item);
                }
            });

            requestAnimationFrame(gameLoop);
        }

        function catchItem(item) {
            item.caught = true;
            item.el.remove();
            score++;
            document.getElementById('scoreVal').innerText = score;

            const playerSock = document.getElementById('playerSock');
            const sockRect = playerSock.getBoundingClientRect();
            
            const ef = document.createElement('div');
            ef.classList.add('catch-effect');
            ef.innerText = "GET!";
            ef.style.left = sockRect.left + 'px';
            ef.style.top = (sockRect.top - 50) + 'px';
            document.getElementById('screen-game').appendChild(ef);
            setTimeout(() => ef.remove(), 500);
        }
    </script>
</body>
</html>
